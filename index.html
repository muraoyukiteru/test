<script>
  const PAGES = document.getElementById('pages');
  const CODE = document.getElementById('deckCode');
  const FETCH_BTN = document.getElementById('fetchBtn');
  const FIT = document.getElementById('fitMode');
  const DEDUPE = document.getElementById('dedupe');

  function makeSheet(images){
    const a4 = document.createElement('div'); a4.className='a4';
    const sheet = document.createElement('div'); sheet.className='sheet';
    for(let i=0;i<9;i++){
      const cell = document.createElement('div'); cell.className='cell';
      const img = document.createElement('img'); img.alt=String(i+1); img.style.objectFit = FIT.value;
      if(images[i]) img.src = images[i];
      cell.appendChild(img); sheet.appendChild(cell);
    }
    a4.appendChild(sheet); return a4;
  }

  function renderPages(urls){
    PAGES.innerHTML = '';
    if(urls.length===0){ PAGES.appendChild(makeSheet([])); return; }
    for(let i=0;i<urls.length;i+=9){ PAGES.appendChild(makeSheet(urls.slice(i,i+9))); }
  }

  FIT.addEventListener('change', ()=> {
    PAGES.querySelectorAll('img').forEach(img => img.style.objectFit = FIT.value);
  });

  async function handleFetch(){
    const code = (CODE.value||'').trim();
    if(!code){ alert('デッキコードを入力してください。'); return; }

    // 同一オリジンで動かすなら空文字、Workers 等の別ドメインならそのURL
    const API_BASE = 'https://pokemon-card.murao-yukiteru.workers.dev/'; // 例) 'https://your-worker-subdomain.workers.dev'
    try{
      FETCH_BTN.disabled = true; FETCH_BTN.textContent = '取得中…';
      const r = await fetch(`${API_BASE}/api/deck?code=${encodeURIComponent(code)}`);
      if(!r.ok) throw new Error('API error '+r.status);
      const data = await r.json();
      let urls = data.images || [];
      if(DEDUPE.checked){ urls = Array.from(new Set(urls)); }
      renderPages(urls);
    }catch(e){
      console.error(e);
      alert('カード画像の取得に失敗しました。時間をおいて再試行してください。');
    }finally{
      FETCH_BTN.disabled = false; FETCH_BTN.textContent = 'カード画像を取得';
    }
  }

  FETCH_BTN.addEventListener('click', handleFetch);
</script>
