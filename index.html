<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Deck Code â†’ A4 3Ã—3 Sheets (63Ã—88mm)</title>
  <style>
    :root{
      --cell-w: 63mm;   /* 1æš æ¨ª63mm */
      --cell-h: 88mm;   /* 1æš ç¸¦88mm */
      --gap: 0mm;       /* ç”»åƒé–“ã®ä½™ç™½ãªã— */
      --grid-w: calc(var(--cell-w) * 3);
      --grid-h: calc(var(--cell-h) * 3);
      --guide: 1.2pt dashed #111; /* å‘¨å›²ã®ç‚¹ç·šã‚¬ã‚¤ãƒ‰ */
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; margin:0; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic UI", "Meiryo", sans-serif;
      background:#f5f7fb; color:#111;
    }
    header{ position:sticky; top:0; z-index:10; background:#fff; border-bottom:1px solid #e5e7eb; }
    .toolbar{ max-width:1100px; margin:0 auto; padding:10px 16px; display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
    .btn{ appearance:none; background:#111; color:#fff; border:none; padding:10px 14px; border-radius:10px; font-weight:600; cursor:pointer; }
    .btn.secondary{ background:#e5e7eb; color:#111; }
    .field{ display:flex; align-items:center; gap:8px; padding:6px 10px; background:#fff; border:1px solid #e5e7eb; border-radius:10px; }
    .field input[type="text"], .field input[type="url"]{ width:320px; max-width:60vw; }

    main{ max-width:1100px; margin:18px auto 80px; padding:0 16px; }

    .a4-wrap{ display:grid; place-items:center; gap:22px; }
    .a4{ width:min(96vw, calc(96vh * (210/297))); aspect-ratio:210/297; background:#fff; box-shadow:0 10px 30px rgba(0,0,0,.08); border-radius:6px; position:relative; overflow:hidden; }
    .sheet{ position:absolute; left:50%; top:50%; width:var(--grid-w); height:var(--grid-h); transform:translate(-50%, -50%); display:grid; grid-template-columns: repeat(3, var(--cell-w)); grid-template-rows: repeat(3, var(--cell-h)); gap:var(--gap); }
    .sheet::before{ content:""; position:absolute; inset:0; border:var(--guide); pointer-events:none; }
    .cell{ width:var(--cell-w); height:var(--cell-h); background:#fff; overflow:hidden; }
    .cell img{ width:100%; height:100%; display:block; object-fit:contain; background:#fff; }

    footer{ text-align:center; color:#6b7280; font-size:12px; padding:24px; }

    /* å°åˆ·ï¼ˆA4å®Ÿå¯¸ï¼‰ */
    @page { size: A4 portrait; margin: 0; }
    @media print{
      body{ background:#fff; }
      header, footer{ display:none; }
      .a4{ width:210mm; height:297mm; box-shadow:none; border-radius:0; }
      .a4 + .a4{ page-break-before: always; }
    }
  </style>
</head>
<body>
  <header>
    <div class="toolbar" role="toolbar" aria-label="Controls">
      <label class="field" title="ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰ä¾‹: ggnNQ9-cFqwyn-NLLn6Q">
        <span>ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰</span>
        <input id="deckCode" type="text" placeholder="ä¾‹: ggnNQ9-cFqwyn-NLLn6Q" />
      </label>
      <button class="btn" id="fetchBtn">ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’å–å¾—</button>
      <button class="btn secondary" id="printBtn" onclick="window.print()">ğŸ–¨ï¸ å°åˆ·</button>
      <label class="field" title="åã¾ã‚Šæ–¹">
        <span>ãƒ•ã‚£ãƒƒãƒˆ</span>
        <select id="fitMode">
          <option value="contain" selected>åˆ‡ã‚ŠæŠœããªã—ï¼ˆä½™ç™½ã‚ã‚Šï¼‰</option>
          <option value="cover">å…¨é¢å„ªå…ˆï¼ˆã¯ã¿å‡ºã—ã‚«ãƒƒãƒˆï¼‰</option>
        </select>
      </label>
      <label class="field" title="åŒã˜ç”»åƒURLã¯1å›ã ã‘ä½¿ã†">
        <input id="dedupe" type="checkbox" checked />é‡è¤‡ç”»åƒã‚’ã¾ã¨ã‚ã‚‹
      </label>
    </div>
  </header>

  <main>
    <section style="margin: 0 0 12px 0; font-size:12px; color:#6b7280;">
      <p>èƒŒæ™¯ã¯ç™½ã®A4ã€‚ä¸­å¤®ã« 63Ã—88mm ã®3Ã—3ï¼ˆä½™ç™½0ã€æ ç·šãªã—ï¼‰ã‚’é…ç½®ã€‚å„ãƒšãƒ¼ã‚¸å¤–å‘¨ã«ç‚¹ç·šã‚¬ã‚¤ãƒ‰ã€‚ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚«ãƒ¼ãƒ‰ç”»åƒï¼ˆJPEGï¼‰ã‚’å–å¾—ã—ã€9æšã”ã¨ã«ãƒšãƒ¼ã‚¸ã‚’å¢—ã‚„ã—ã¾ã™ã€‚9æšã«æº€ãŸãªã„æœ€å¾Œã®ãƒšãƒ¼ã‚¸ã¯ç©ºç™½ã‚»ãƒ«ã‚’æ®‹ã—ã¾ã™ã€‚</p>
    </section>

    <div id="pages" class="a4-wrap"></div>
  </main>

  <footer>
    å–å¾—ã«å¤±æ•—ã™ã‚‹å ´åˆã¯ã‚µã‚¤ãƒˆå´ã®åˆ¶é™ï¼ˆCORSç­‰ï¼‰ã«ã‚ˆã‚‹ã‚‚ã®ã§ã™ã€‚ãã®å ´åˆã¯è‡ªå‹•å›é¿ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’ä½¿ã„ã¾ã™ã€‚
  </footer>

  <script>
    const PAGES = document.getElementById('pages');
    const CODE = document.getElementById('deckCode');
    const FETCH_BTN = document.getElementById('fetchBtn');
    const FIT = document.getElementById('fitMode');
    const DEDUPE = document.getElementById('dedupe');

    function makeSheet(images){
      // 1ãƒšãƒ¼ã‚¸ï¼ˆA4ï¼‰ã‚’ä½œã£ã¦9ã‚»ãƒ«é…ç½®
      const a4 = document.createElement('div');
      a4.className = 'a4';
      const sheet = document.createElement('div');
      sheet.className = 'sheet';
      for(let i=0;i<9;i++){
        const cell = document.createElement('div');
        cell.className = 'cell';
        const img = document.createElement('img');
        img.alt = String(i+1);
        img.style.objectFit = FIT.value;
        if(images[i]) img.src = images[i]; // ç©ºç™½ã‚»ãƒ«ã¯srcæœªè¨­å®šï¼ˆç™½ï¼‰
        cell.appendChild(img);
        sheet.appendChild(cell);
      }
      a4.appendChild(sheet);
      return a4;
    }

    function renderPages(urls){
      PAGES.innerHTML = '';
      if(urls.length === 0){
        PAGES.appendChild(makeSheet([]));
        return;
      }
      for(let i=0;i<urls.length; i+=9){
        const slice = urls.slice(i, i+9);
        PAGES.appendChild(makeSheet(slice));
      }
    }

    FIT.addEventListener('change', ()=>{
      // åæ˜ ï¼ˆæ—¢å­˜ã®imgã«é©ç”¨ï¼‰
      PAGES.querySelectorAll('img').forEach(img => img.style.objectFit = FIT.value);
    });

    async function fetchText(url){
      // é€šå¸¸fetch â†’ å¤±æ•—æ™‚ã« r.jina.ai çµŒç”±ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆCORSå›é¿ï¼‰
      try{
        const r = await fetch(url, { mode: 'cors' });
        if(!r.ok) throw new Error('HTTP '+r.status);
        return await r.text();
      }catch(e){
        console.warn('Direct fetch failed, fallback via r.jina.ai', e);
        const fallback0 = 'https://r.jina.ai/' + url; // https://r.jina.ai/https://...
        const r2 = await fetch(fallback0);
        if(r2.ok) return await r2.text();
        const fallback1 = 'https://r.jina.ai/http://'+ url.replace(/^https?:\/\//,'');
        const r3 = await fetch(fallback1);
        if(!r3.ok) throw new Error('Fallback failed: '+r3.status);
        return await r3.text();
      }
    }

    function extractImageUrls(html){
      // ãƒ‡ãƒƒã‚­ãƒšãƒ¼ã‚¸å†…ã«ç¾ã‚Œã‚‹å¤§ã‚µã‚¤ã‚ºç”»åƒURLã‚’æŠ½å‡º
      const re = /https?:\\/\\/www\.pokemon-card\.com\\/assets\\/images\\/card_images\\/large\\/[^\"'\s<>]+\.jpg/gi;
      const found = html.match(re) || [];
      // é †åºç¶­æŒã§ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–
      const seen = new Set();
      const urls = [];
      for(const u of found){ if(!seen.has(u)){ seen.add(u); urls.push(u); } }
      return urls;
    }

    async function handleFetch(){
      const code = (CODE.value || '').trim();
      if(!code){ alert('ãƒ‡ãƒƒã‚­ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return; }
      const url = `https://www.pokemon-card.com/deck/${encodeURIComponent(code)}`;
      try{
        FETCH_BTN.disabled = true; FETCH_BTN.textContent = 'å–å¾—ä¸­â€¦';
        const html = await fetchText(url);
        let urls = extractImageUrls(html);
        if(DED UPE.checked){
          // æ—¢ã«ãƒ¦ãƒ‹ãƒ¼ã‚¯åŒ–æ¸ˆã¿ã ãŒã€å¿µã®ãŸã‚
          const t = []; const s = new Set();
          for(const u of urls){ if(!s.has(u)){ s.add(u); t.push(u); } }
          urls = t;
        }
        renderPages(urls);
      }catch(err){
        console.error(err);
        alert('ã‚«ãƒ¼ãƒ‰ç”»åƒã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ã‚³ãƒ¼ãƒ‰ãŒæ­£ã—ã„ã‹ã€æ™‚é–“ã‚’ãŠã„ã¦å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
      }finally{
        FETCH_BTN.disabled = false; FETCH_BTN.textContent = 'ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’å–å¾—';
      }
    }

    FETCH_BTN.addEventListener('click', handleFetch);

    // ãƒ‡ãƒ¢ç”¨: ã‚µãƒ³ãƒ—ãƒ«ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Œã°è‡ªå‹•å…¥åŠ›
    // CODE.value = 'ggnNQ9-cFqwyn-NLLn6Q';
  </script>
</body>
</html>
